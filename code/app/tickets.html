<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tickets</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7fb; }
        .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
        .card { background: #fff; border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.08); padding: 18px; }
        h1 { font-size: 18px; margin: 0 0 12px; }
        .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .grid > label { grid-column: span 2; }
        .grid .wide { grid-column: span 3; }
        .grid .narrow { grid-column: span 1; }
        label { display: grid; gap: 6px; font-size: 12px; color: #333; }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid #d7dbe7; border-radius: 10px; font: inherit; background: #fff; }
        button { border: 0; border-radius: 12px; padding: 10px 14px; background: #111827; color: #fff; cursor: pointer; font: inherit; }
        button.secondary { background: #374151; }
        button[disabled] { opacity: .55; cursor: not-allowed; }
        .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .muted { color:#6b7280; font-size:12px; }
        .err { color:#991b1b; background:#fef2f2; border:1px solid #fecaca; padding:10px 12px; border-radius:12px; margin-top:12px; }
        .ok  { color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:10px 12px; border-radius:12px; margin-top:12px; }
        table { width:100%; border-collapse: collapse; margin-top:12px; }
        th, td { text-align:left; padding:10px 10px; border-bottom:1px solid #eef0f6; font-size: 13px; vertical-align: top; }
        th { font-size:12px; color:#374151; }
        a { color:#1f2937; }
        .badge { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1f2937; }
        .badge.NEW { background:#eef2ff; }
        .badge.IN_PROCESS { background:#fff7ed; }
        .badge.DONE { background:#ecfdf5; }
        pre { white-space: pre-wrap; word-break: break-word; background:#0b1020; color:#e5e7eb; padding:12px; border-radius:12px; overflow:auto; }
        .split { display:grid; grid-template-columns: 2fr 1fr; gap: 12px; }
        @media (max-width: 980px) { .split { grid-template-columns: 1fr; } .grid { grid-template-columns: 1fr 1fr; } .grid > label { grid-column: auto; } }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>–ó–∞—è–≤–∫–∏</h1>

        <div class="split">
            <div>
                <div class="grid" style="margin-bottom:12px">
                    <label class="wide">
                        Authorization token
                        <input id="authToken" placeholder="token12345" />
                    </label>

                    <label class="narrow">
                        –°—Ç–∞—Ç—É—Å
                        <select id="filterStatus">
                            <option value="">(–ª—é–±–æ–π)</option>
                            <option value="NEW">NEW</option>
                            <option value="IN_PROCESS">IN_PROCESS</option>
                            <option value="DONE">DONE</option>
                        </select>
                    </label>

                    <label class="wide">
                        Email —Å–æ–¥–µ—Ä–∂–∏—Ç
                        <input id="filterEmail" placeholder="customer" />
                    </label>

                    <label class="wide">
                        –¢–µ–ª–µ—Ñ–æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç
                        <input id="filterPhone" placeholder="551" />
                    </label>

                    <label class="wide">
                        createdAtFrom (YYYY-MM-DD HH:MM:SS)
                        <input id="filterFrom" placeholder="2022-01-01 00:00:00" />
                    </label>

                    <label class="wide">
                        createdAtTo (YYYY-MM-DD HH:MM:SS)
                        <input id="filterTo" placeholder="2026-01-01 23:59:59" />
                    </label>
                </div>

                <div class="row">
                    <button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    <button id="btnClear" class="secondary" type="button">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <span id="status" class="muted"></span>
                </div>

                <div id="msg"></div>

                <table id="table" hidden>
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–¢–µ–º–∞</th>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–°–æ–∑–¥–∞–Ω–æ</th>
                        <th>–û—Ç–∫—Ä—ã—Ç—å</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>

                <pre id="debug" hidden></pre>
            </div>

            <div>
                <div class="card" style="box-shadow:none; border:1px solid #eef0f6; background:#fafbff">
                    <div class="row" style="justify-content:space-between">
                        <strong style="font-size:13px">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
                        <button id="btnStats" class="secondary" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                    <div id="stats" class="muted" style="margin-top:10px">–ù–∞–∂–º–∏ ‚Äú–û–±–Ω–æ–≤–∏—Ç—å‚Äù –µ—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è —Ü–∏—Ñ—Ä.</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const API_BASE = ""; // –µ—Å–ª–∏ –Ω–∞–¥–æ: "https://api.example.com"
    const $ = (s) => document.querySelector(s);

    const authTokenEl = $("#authToken");
    const filterStatusEl = $("#filterStatus");
    const filterEmailEl = $("#filterEmail");
    const filterPhoneEl = $("#filterPhone");
    const filterFromEl = $("#filterFrom");
    const filterToEl = $("#filterTo");

    const btnLoad = $("#btnLoad");
    const btnClear = $("#btnClear");
    const btnStats = $("#btnStats");
    const statusEl = $("#status");
    const msgEl = $("#msg");

    const tableEl = $("#table");
    const tbodyEl = $("#tbody");
    const debugEl = $("#debug");
    const statsEl = $("#stats");

    function setStatus(t) { statusEl.textContent = t || ""; }
    function showMsg(type, text) {
        msgEl.innerHTML = "";
        if (!text) return;
        const div = document.createElement("div");
        div.className = type === "ok" ? "ok" : "err";
        div.textContent = text;
        msgEl.appendChild(div);
    }
    function setDebug(obj) {
        debugEl.hidden = !obj;
        debugEl.textContent = obj ? JSON.stringify(obj, null, 2) : "";
    }

    function buildQuery() {
        const p = new URLSearchParams();

        const email = filterEmailEl.value.trim();
        const phone = filterPhoneEl.value.trim();
        const status = filterStatusEl.value.trim();
        const from = filterFromEl.value.trim();
        const to = filterToEl.value.trim();

        if (email) p.set("filter[email]", email);
        if (phone) p.set("filter[phone]", phone);
        if (status) p.set("filter[status]", status);
        if (from) p.set("filter[createdAtFrom]", from);
        if (to) p.set("filter[createdAtTo]", to);

        const q = p.toString();
        return q ? ("?" + q) : "";
    }

    async function apiFetch(path, { method = "GET", body = null } = {}) {
        const headers = {};
        // const token = authTokenEl.value.trim();
        const token = 'token12345';
        if (token) headers["Authorization"] = token;

        let opts = { method, headers };
        if (body !== null) {
            headers["Content-Type"] = "application/json";
            opts.body = JSON.stringify(body);
        }

        const res = await fetch(API_BASE + path, opts);
        const text = await res.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch {}
        return { res, text, json };
    }

    function normalizeListData(data) {
        // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ ‚Äú—É—Å—Ç–æ–π—á–∏–≤–æ –∫ —Ö–∞–æ—Å—É‚Äù:
        if (!data) return [];
        if (Array.isArray(data)) return data;
        if (Array.isArray(data.items)) return data.items;
        if (Array.isArray(data.data)) return data.data;
        if (Array.isArray(data.results)) return data.results;
        return [];
    }

    function renderTable(list) {
        tbodyEl.innerHTML = "";
        if (!list.length) {
            tableEl.hidden = true;
            return;
        }
        tableEl.hidden = false;

        for (const t of list) {
            const tr = document.createElement("tr");

            const id = t.id ?? "";
            const status = t.status ?? "";
            const topic = t.topic ?? "";
            const createdAt = t.createdAt ?? t.created_at ?? t.created ?? "";
            const customer = t.customer ?? {};
            const customerText = [
                customer.name ? `üë§ ${customer.name}` : null,
                customer.email ? `‚úâÔ∏è ${customer.email}` : null,
                customer.phone ? `üìû ${customer.phone}` : null,
            ].filter(Boolean).join("\n");

            tr.innerHTML = `
          <td>${escapeHtml(String(id))}</td>
          <td><span class="badge ${escapeHtml(String(status))}">${escapeHtml(String(status))}</span></td>
          <td>${escapeHtml(String(topic))}</td>
          <td style="white-space:pre-line">${escapeHtml(customerText)}</td>
          <td>${escapeHtml(String(createdAt))}</td>
          <td><a href="tickets-detail.html?id=${encodeURIComponent(String(id))}">tickets-detail</a></td>
        `;
            tbodyEl.appendChild(tr);
        }
    }

    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    async function loadTickets() {
        showMsg("", "");
        setDebug(null);
        setStatus("–ó–∞–≥—Ä—É–∂–∞—é...");
        btnLoad.disabled = true;

        try {
            const q = buildQuery();
            const { res, json, text } = await apiFetch("/api/tickets" + q);

            if (!res.ok) {
                const msg = json?.message || text || `HTTP ${res.status}`;
                showMsg("err", msg);
                renderTable([]);
                setDebug(json || { status: res.status, raw: text });
                return;
            }

            const list = normalizeListData(json?.data);
            renderTable(list);
            showMsg("ok", `–û–ö. –ù–∞–π–¥–µ–Ω–æ: ${list.length}`);
            setDebug(json); // —á—Ç–æ–±—ã –ø—Ä–æ—â–µ –±—ã–ª–æ –ø–æ–¥–æ–≥–Ω–∞—Ç—å –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        } catch (e) {
            showMsg("err", e?.message || String(e));
        } finally {
            setStatus("");
            btnLoad.disabled = false;
        }
    }

    async function loadStats() {
        statsEl.textContent = "–°—á–∏—Ç–∞—é...";
        try {
            const { res, json, text } = await apiFetch("/api/tickets/statistics");
            if (!res.ok) {
                statsEl.textContent = json?.message || text || `HTTP ${res.status}`;
                return;
            }
            // –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –ø–æ–∫–∞–∂–µ–º –∫–∞–∫ –µ—Å—Ç—å
            statsEl.innerHTML = `<pre style="margin:10px 0 0">${escapeHtml(JSON.stringify(json?.data ?? json, null, 2))}</pre>`;
        } catch (e) {
            statsEl.textContent = e?.message || String(e);
        }
    }

    btnLoad.addEventListener("click", loadTickets);
    btnStats.addEventListener("click", loadStats);

    btnClear.addEventListener("click", () => {
        filterStatusEl.value = "";
        filterEmailEl.value = "";
        filterPhoneEl.value = "";
        filterFromEl.value = "";
        filterToEl.value = "";
        showMsg("", "");
        renderTable([]);
        setDebug(null);
    });

    // –∞–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞ –µ—Å–ª–∏ –≤ URL –µ—Å—Ç—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ ?filter[email]=...
    if (location.search.includes("filter%5B") || location.search.includes("filter[")) {
        const p = new URLSearchParams(location.search);
        filterEmailEl.value = p.get("filter[email]") || "";
        filterPhoneEl.value = p.get("filter[phone]") || "";
        filterStatusEl.value = p.get("filter[status]") || "";
        filterFromEl.value = p.get("filter[createdAtFrom]") || "";
        filterToEl.value = p.get("filter[createdAtTo]") || "";
        loadTickets();
    }
</script>
</body>
</html>
